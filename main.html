<!DOCTYPE html>

<html>
    <head>
        <title>Surprise lunch</title>
        <script src="http://code.jquery.com/jquery-latest.min.js"></script>
        <link rel="stylesheet" href="bootstrap/css/bootstrap.min.css"  type="text/css"/>
        <script src="bootstrap/js/bootstrap.js"></script>
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
        <style>
            .container-fluid {
            padding:0;
            }
            .navbar {
            margin:0;
            padding:15px 0 15px 0;
            }
            .btn {
            margin:60px;                   
            }
            span.glyphicon {
            font-size: 3.0em;
            }
        </style>
    </head>
    
    <body>
        <div class="container-fluid">
            <div class="navbar navbar-default">
                <h1 class="text-center">Surprise Lunch</h1>
            </div>
        

        <div class="container text-center">
        <button style="width:200px height: 200px" type="button" class="btn btn-default btn-lg" onclick="getLocation()"> <span class="glyphicon glyphicon-map-marker"></span></button>
        <h2 id="restaurant_name"></h2>
        <h4 id="restaurant_kind"></h4>
        <button id="choose_next_btn" type="button" class="btn btn-default btn-lg" style="display:none" onclick="choose_random_restaurant()">Nope!</button>
	    </div>

        

        <script>
            var res_name = document.getElementById("restaurant_name");
            var res_kind = document.getElementById("restaurant_kind");
            var current_restaurants = {}
            
            function getLocation() {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(sendLocation);
                } else {
                    x.res_name = "Geolocation is not supported by this browser.";
                }
            }
            
            function choose_random_restaurant_index() {
                if (current_restaurants.length != 0) {
                    // choose a random value
                    return Math.floor((Math.random() * current_restaurants.length));                   
                } else {
                    return -1;
                }
            }
            
            function show_restaurant(restaurant) {
                res_name.innerHTML = restaurant.name
                 
                var all_categories = ""; 

                console.debug('categories: ', restaurant.categories);
                var all_categories = [];
                for (var i = 0; i < restaurant.categories.length; i++) { 
                    all_categories.push(restaurant.categories[i][0]);
                }              
                res_kind.innerHTML = all_categories.join(", ");
                console.debug('Restaurant chosen: ', restaurant); 
            }
            
            function choose_random_restaurant() {
                console.debug('restaurants before', current_restaurants);
                
                var index_chosen = choose_random_restaurant_index();
                
                console.debug('random index', index_chosen);    
                
                if (index_chosen != -1) {
                    // show the restaurant
                    show_restaurant(current_restaurants[index_chosen]);
                    // delete it
                    current_restaurants.splice(index_chosen, 1);
                } else {
                    // show no restaurants left
                    res_name.innerHTML = "Sorry, no restaurants left :("
                    res_kind.innerHTML = "";
                    document.getElementById("choose_next_btn").style.display = "none";
                }
                console.debug('restaurants after', current_restaurants);
            }
            
            function on_request_success(response) {
                //console.debug('response', response); 
                document.getElementById("choose_next_btn").style.display = "inline";
                current_restaurants = response.businesses
                //response.businesses.splice(0,1);
                //console.debug('restaurants', response.businesses); 
                choose_random_restaurant()
            } 
            
            function on_request_error(r, text_status, error_thrown) {
                //console.debug('error'); 
                console.debug('error', text_status + ", " + error_thrown + ":\n" + r.responseText);
            }
            
            function sendLocation(position) {     
                var location = {}
                location['latitude'] = position.coords.latitude
                location['longitude'] = position.coords.longitude
                
                $.ajax({
                    url: '/location',
                    type: 'POST',
                    data: JSON.stringify(location),
                    contentType: 'application/json',
                    success: on_request_success,
                    error: on_request_error  
                });
  
                //x.innerHTML="Latitude: " + position.coords.latitude + 
                //"<br>Longitude: " + position.coords.longitude;	
            }
           
        </script>
        </div>
    </body>
</html>